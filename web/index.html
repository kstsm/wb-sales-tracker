<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>SalesTracker - Учёт продаж и аналитика</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        *{box-sizing:border-box;margin:0;padding:0}
        body{font-family:Arial,Helvetica,sans-serif;background:#f5f5f5;padding:20px}
        .container{max-width:1100px;margin:0 auto}
        h1{margin-bottom:16px;color:#222}
        .section{background:#fff;padding:20px;border-radius:8px;margin-bottom:16px;border:1px solid #e6e6e6}
        h2{margin-bottom:16px;color:#222;font-size:20px}
        .form-group{margin:12px 0}
        label{display:block;margin-bottom:6px;font-weight:600}
        input,select,button{padding:8px;border-radius:6px;border:1px solid #dcdcdc;font-size:14px;width:100%}
        button.btn{background:#007bff;color:#fff;border:none;cursor:pointer;padding:10px 14px;width:auto}
        button.btn:hover{background:#0056b3}
        button.secondary{background:#6c757d;color:#fff}
        button.secondary:hover{background:#5a6268}
        button.danger{background:#dc3545;color:#fff}
        button.danger:hover{background:#c82333}
        button.small{padding:4px 8px;font-size:12px;font-weight:normal}
        .error{color:#dc3545;padding:10px;background:#f8d7da;border-radius:4px;margin-bottom:20px;display:none}
        .success{color:#155724;padding:10px;background:#d4edda;border-radius:4px;margin-bottom:20px;display:none}
        .filters{display:flex;flex-wrap:wrap;gap:12px;margin-bottom:10px}
        .filters .form-group{flex:1;min-width:150px}
        .table-container{overflow-x:auto;margin-top:16px}
        table{width:100%;border-collapse:collapse}
        th,td{padding:10px;text-align:left;border-bottom:1px solid #e6e6e6}
        th{background:#f8f9fa;font-weight:600;color:#555}
        tr:hover{background:#f8f9fa}
        .badge{display:inline-block;padding:4px 8px;border-radius:4px;font-size:12px;font-weight:600}
        .badge-income{background:#d4edda;color:#155724}
        .badge-expense{background:#f8d7da;color:#721c24}
        .analytics-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-bottom:20px}
        .analytics-card{background:#fff;padding:16px;border-radius:8px;border:1px solid #e6e6e6;text-align:center}
        .analytics-card h3{font-size:14px;color:#666;margin-bottom:8px;font-weight:600}
        .analytics-card .value{font-size:24px;font-weight:bold;color:#222}
        .chart-container{position:relative;height:300px;margin-top:16px}
        .loading{text-align:center;padding:20px;color:#666}
        .actions{display:flex;gap:8px}
        .actions button{padding:6px 12px;font-size:13px;width:auto}
        .empty-state{text-align:center;padding:40px;color:#999}
        .form-row{display:flex;gap:12px;flex-wrap:wrap}
        .form-row .form-group{flex:1;min-width:200px}
        .button-group{display:flex;gap:8px;margin-top:12px;margin-bottom:12px}
    </style>
</head>
<body>
<div class="container">
    <h1>SalesTracker</h1>
    <div id="message"></div>

    <div class="section">
        <h2>Добавить запись</h2>
        <form id="itemForm">
            <div class="form-row">
                <div class="form-group">
                    <label for="type">Тип *</label>
                    <select id="type" >
                        <option value="">Выберите тип</option>
                        <option value="income">Доход</option>
                        <option value="expense">Расход</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="amount">Сумма *</label>
                    <input type="number" id="amount" step="0.01" min="0.01">
                </div>
                <div class="form-group">
                    <label for="date">Дата *</label>
                    <input type="datetime-local" id="date">
                </div>
                <div class="form-group">
                    <label for="category">Категория *</label>
                    <input type="text" id="category">
                </div>
            </div>
            <div style="margin-top:12px">
                <button type="submit" class="btn">Добавить запись</button>
            </div>
        </form>
    </div>

    <div class="section">
        <h2>Аналитика</h2>
        <div class="filters">
            <div class="form-group">
                <label for="analyticsFrom">От</label>
                <input type="date" id="analyticsFrom">
            </div>
            <div class="form-group">
                <label for="analyticsTo">До</label>
                <input type="date" id="analyticsTo">
            </div>
            <div class="form-group">
                <label for="analyticsGroupBy">Группировка</label>
                <select id="analyticsGroupBy">
                    <option value="">Без группировки</option>
                    <option value="day">По дням</option>
                    <option value="week">По неделям</option>
                    <option value="category">По категориям</option>
                </select>
            </div>
            <div class="form-group" style="display:flex;align-items:flex-end">
                <button class="btn" onclick="loadAnalytics()">Обновить аналитику</button>
            </div>
        </div>
        <div id="analytics" class="analytics-grid"></div>
        <div id="groupedAnalytics" style="display:none;margin-top:20px">
            <h3 style="margin-bottom:16px;color:#222;font-size:18px">Группированные данные</h3>
            <div class="table-container">
                <table id="groupedTable">
                    <thead>
                        <tr>
                            <th>Группа</th>
                            <th>Сумма</th>
                            <th>Среднее</th>
                            <th>Количество</th>
                            <th>Медиана</th>
                            <th>90-й перцентиль</th>
                        </tr>
                    </thead>
                    <tbody id="groupedTableBody"></tbody>
                </table>
            </div>
        </div>
        <div class="chart-container">
            <canvas id="analyticsChart"></canvas>
        </div>
    </div>

    <div class="section">
        <h2 style="font-size:20px;margin-bottom:16px">Редактировать запись</h2>
        <form id="editForm">
            <div class="form-row">
                <div class="form-group" style="margin:4px 0">
                    <label for="editType" style="margin-bottom:2px;font-size:16px">Тип *</label>
                    <select id="editType" style="padding:6px;font-size:13px">
                        <option value="">Выберите тип</option>
                        <option value="income">Доход</option>
                        <option value="expense">Расход</option>
                    </select>
                </div>
                <div class="form-group" style="margin:4px 0">
                    <label for="editAmount" style="margin-bottom:2px;font-size:16px">Сумма *</label>
                    <input type="number" id="editAmount" step="0.01" min="0.01" style="padding:6px;font-size:13px">
                </div>
                <div class="form-group" style="margin:4px 0">
                    <label for="editDate" style="margin-bottom:2px;font-size:16px">Дата *</label>
                    <input type="datetime-local" id="editDate" style="padding:6px;font-size:13px">
                </div>
                <div class="form-group" style="margin:4px 0">
                    <label for="editCategory" style="margin-bottom:2px;font-size:16px">Категория *</label>
                    <input type="text" id="editCategory" style="padding:6px;font-size:13px">
                </div>
            </div>
            <div class="button-group">
                <button type="submit" class="btn" style="padding:6px 12px;font-size:13px">Сохранить изменения</button>
                <button type="button" class="secondary" style="padding:6px 12px;font-size:13px" onclick="cancelEdit()">Отмена</button>
            </div>
        </form>
    </div>

    <div class="section">
        <h2 style="font-size:20px;margin-bottom:16px">Список записей</h2>
        <div class="filters">
            <div class="form-group">
                <label for="filterFrom">От</label>
                <input type="date" id="filterFrom">
            </div>
            <div class="form-group">
                <label for="filterTo">До</label>
                <input type="date" id="filterTo">
            </div>
            <div class="form-group">
                <label for="filterType">Тип</label>
                <select id="filterType">
                    <option value="">Все</option>
                    <option value="income">Доход</option>
                    <option value="expense">Расход</option>
                </select>
            </div>
            <div class="form-group">
                <label for="filterCategory">Категория</label>
                <input type="text" id="filterCategory" placeholder="Любая">
            </div>
            <div class="form-group">
                <label for="sortBy">Сортировка</label>
                <select id="sortBy">
                    <option value="date">По дате</option>
                    <option value="amount">По сумме</option>
                    <option value="category">По категории</option>
                </select>
            </div>
            <div class="form-group">
                <label for="sortOrder">Порядок</label>
                <select id="sortOrder">
                    <option value="desc">По убыванию</option>
                    <option value="asc">По возрастанию</option>
                </select>
            </div>
        </div>
        <div class="button-group">
            <button class="btn" style="padding:6px 12px;font-size:13px" onclick="loadItems()">Применить фильтры</button>
            <button class="secondary" style="padding:6px 12px;font-size:13px" onclick="exportCSV()">Экспорт в CSV</button>
        </div>
        
        <div class="table-container">
            <table id="itemsTable">
                <thead>
                    <tr>
                        <th>Тип</th>
                        <th>Сумма</th>
                        <th>Дата</th>
                        <th>Категория</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody id="itemsTableBody">
                    <tr>
                        <td colspan="5" class="loading">Загрузка...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    let editingItemId = null;
    let analyticsChart = null;

    document.getElementById('date').value = new Date().toISOString().slice(0, 16);

    window.onload = function() {
        const today = new Date();
        const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
        
        document.getElementById('analyticsFrom').value = firstDay.toISOString().slice(0, 10);
        document.getElementById('analyticsTo').value = today.toISOString().slice(0, 10);
        
        loadItems();
        loadAnalytics();
    };

    document.getElementById('itemForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const amountValue = parseFloat(document.getElementById('amount').value);
        const amountInKopeks = Math.round(amountValue * 100);
        
        const formData = {
            type: document.getElementById('type').value,
            amount: amountInKopeks,
            date: new Date(document.getElementById('date').value).toISOString(),
            category: document.getElementById('category').value
        };

        try {
            const response = await fetch('/api/items', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });

            const data = await response.json();
            if (!response.ok) {
                showMessage(data.error || 'Ошибка при сохранении', 'error');
                return;
            }

            showMessage('Запись добавлена', 'success');
            resetForm();
            loadItems();
            loadAnalytics();
        } catch (error) {
            showMessage('Ошибка: ' + error.message, 'error');
        }
    });

    async function loadItems() {
        const params = new URLSearchParams();
        if (document.getElementById('filterFrom').value) {
            params.append('from', document.getElementById('filterFrom').value + 'T00:00:00Z');
        }
        if (document.getElementById('filterTo').value) {
            params.append('to', document.getElementById('filterTo').value + 'T23:59:59Z');
        }
        if (document.getElementById('filterType').value) {
            params.append('type', document.getElementById('filterType').value);
        }
        if (document.getElementById('filterCategory').value) {
            params.append('category', document.getElementById('filterCategory').value);
        }
        if (document.getElementById('sortBy').value) {
            params.append('sort_by', document.getElementById('sortBy').value);
        }
        if (document.getElementById('sortOrder').value) {
            params.append('sort_order', document.getElementById('sortOrder').value);
        }

        try {
            const response = await fetch(`/api/items?${params}`);
            const data = await response.json();
            
            if (!response.ok) {
                showMessage(data.error || 'Ошибка при загрузке', 'error');
                return;
            }

            const tbody = document.getElementById('itemsTableBody');
            if (data.items && data.items.length > 0) {
                tbody.innerHTML = data.items.map(item => {
                    const escapedId = item.id.replace(/'/g, "\\'");
                    return `
                    <tr data-item-id="${escapedId}">
                        <td><span class="badge badge-${item.type}">${item.type === 'income' ? 'Доход' : 'Расход'}</span></td>
                        <td>${item.amount} ₽</td>
                        <td>${new Date(item.date).toLocaleString('ru-RU')}</td>
                        <td>${item.category}</td>
                        <td class="actions">
                            <button class="secondary" data-action="edit" data-id="${escapedId}">Редактировать</button>
                            <button class="danger" data-action="delete" data-id="${escapedId}">Удалить</button>
                        </td>
                    </tr>
                `;
                }).join('');
                
                // Добавляем обработчики событий для кнопок
                tbody.querySelectorAll('[data-action="edit"]').forEach(btn => {
                    btn.addEventListener('click', function() {
                        editItem(this.getAttribute('data-id'));
                    });
                });
                
                tbody.querySelectorAll('[data-action="delete"]').forEach(btn => {
                    btn.addEventListener('click', function() {
                        deleteItem(this.getAttribute('data-id'));
                    });
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="5" class="empty-state">Нет записей</td></tr>';
            }
        } catch (error) {
            showMessage('Ошибка: ' + error.message, 'error');
        }
    }

    async function loadAnalytics() {
        const fromValue = document.getElementById('analyticsFrom').value;
        const toValue = document.getElementById('analyticsTo').value;
        
        if (!fromValue || !toValue) {
            showMessage('Заполните поля "От" и "До" для загрузки аналитики', 'error');
            return;
        }
        
        const params = new URLSearchParams();
        params.append('from', fromValue + 'T00:00:00Z');
        params.append('to', toValue + 'T23:59:59Z');
        if (document.getElementById('analyticsGroupBy').value) {
            params.append('group_by', document.getElementById('analyticsGroupBy').value);
        }

        try {
            const response = await fetch(`/api/analytics?${params}`);
            const data = await response.json();
            
            if (!response.ok) {
                showMessage(data.error || 'Ошибка при загрузке аналитики', 'error');
                return;
            }

            const analyticsDiv = document.getElementById('analytics');
            analyticsDiv.innerHTML = `
                <div class="analytics-card">
                    <h3>Сумма</h3>
                    <div class="value">${data.sum ? data.sum.toFixed(2) : '0.00'} ₽</div>
                </div>
                <div class="analytics-card">
                    <h3>Среднее</h3>
                    <div class="value">${data.avg ? data.avg.toFixed(2) : '0.00'} ₽</div>
                </div>
                <div class="analytics-card">
                    <h3>Количество</h3>
                    <div class="value">${data.count || 0}</div>
                </div>
                <div class="analytics-card">
                    <h3>Медиана</h3>
                    <div class="value">${data.median ? data.median.toFixed(2) : 'N/A'} ${data.median ? '₽' : ''}</div>
                </div>
                <div class="analytics-card">
                    <h3>90-й перцентиль</h3>
                    <div class="value">${data.percentile90 ? data.percentile90.toFixed(2) : 'N/A'} ${data.percentile90 ? '₽' : ''}</div>
                </div>
            `;

            if (data.grouped && data.grouped.length > 0) {
                const groupedDiv = document.getElementById('groupedAnalytics');
                const tbody = document.getElementById('groupedTableBody');
                groupedDiv.style.display = 'block';
                
                tbody.innerHTML = data.grouped.map(item => `
                    <tr>
                        <td>${item.group}</td>
                        <td>${item.sum ? item.sum.toFixed(2) : '0.00'} ₽</td>
                        <td>${item.avg ? item.avg.toFixed(2) : 'N/A'} ${item.avg ? '₽' : ''}</td>
                        <td>${item.count || 0}</td>
                        <td>${item.median ? item.median.toFixed(2) : 'N/A'} ${item.median ? '₽' : ''}</td>
                        <td>${item.percentile90 ? item.percentile90.toFixed(2) : 'N/A'} ${item.percentile90 ? '₽' : ''}</td>
                    </tr>
                `).join('');
                
                updateGroupedChart(data.grouped);
            } else {
                document.getElementById('groupedAnalytics').style.display = 'none';
                updateChart(data);
            }
        } catch (error) {
            showMessage('Ошибка: ' + error.message, 'error');
        }
    }

    function updateChart(data) {
        const ctx = document.getElementById('analyticsChart').getContext('2d');
        
        if (analyticsChart) {
            analyticsChart.destroy();
        }

        const labels = ['Сумма', 'Среднее', 'Медиана', '90-й перцентиль'];
        const values = [
            data.sum || 0,
            data.avg || 0,
            data.median || 0,
            data.percentile90 || 0
        ];

        analyticsChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Значения (₽)',
                    data: values,
                    backgroundColor: 'rgba(0, 123, 255, 0.8)',
                    borderColor: 'rgba(0, 123, 255, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    function updateGroupedChart(groupedData) {
        const ctx = document.getElementById('analyticsChart').getContext('2d');
        
        if (analyticsChart) {
            analyticsChart.destroy();
        }

        const labels = groupedData.map(item => item.group);
        const sums = groupedData.map(item => item.sum || 0);
        const avgs = groupedData.map(item => item.avg || 0);

        analyticsChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Сумма (₽)',
                    data: sums,
                    backgroundColor: 'rgba(0, 123, 255, 0.8)',
                    borderColor: 'rgba(0, 123, 255, 1)',
                    borderWidth: 1
                }, {
                    label: 'Среднее (₽)',
                    data: avgs,
                    backgroundColor: 'rgba(40, 167, 69, 0.8)',
                    borderColor: 'rgba(40, 167, 69, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    async function editItem(id) {
        try {
            const response = await fetch(`/api/items/${id}`);
            const item = await response.json();
            
            if (!response.ok) {
                showMessage(item.error || 'Ошибка при загрузке записи', 'error');
                return;
            }

            editingItemId = id;
            
            document.getElementById('editType').value = item.type;
            document.getElementById('editAmount').value = parseFloat(item.amount);
            const dateObj = new Date(item.date);
            const localDate = new Date(dateObj.getTime() - dateObj.getTimezoneOffset() * 60000);
            document.getElementById('editDate').value = localDate.toISOString().slice(0, 16);
            document.getElementById('editCategory').value = item.category;
        } catch (error) {
            showMessage('Ошибка: ' + error.message, 'error');
        }
    }
    
    function cancelEdit() {
        editingItemId = null;
        document.getElementById('editForm').reset();
    }
    
    // Обработка формы редактирования
    document.getElementById('editForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        if (!editingItemId) {
            return;
        }
        
        const amountValue = parseFloat(document.getElementById('editAmount').value);
        const amountInKopeks = Math.round(amountValue * 100);
        
        const formData = {
            type: document.getElementById('editType').value,
            amount: amountInKopeks,
            date: new Date(document.getElementById('editDate').value).toISOString(),
            category: document.getElementById('editCategory').value
        };

        try {
            const response = await fetch(`/api/items/${editingItemId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });

            const data = await response.json();
            if (!response.ok) {
                showMessage(data.error || 'Ошибка при обновлении', 'error');
                return;
            }

            showMessage('Запись обновлена', 'success');
            cancelEdit();
            loadItems();
            loadAnalytics();
        } catch (error) {
            showMessage('Ошибка: ' + error.message, 'error');
        }
    });

    async function deleteItem(id) {
        if (!confirm('Вы уверены, что хотите удалить эту запись?')) {
            return;
        }

        try {
            const response = await fetch(`/api/items/${id}`, {
                method: 'DELETE'
            });

            if (!response.ok) {
                const data = await response.json().catch(() => ({ error: 'Ошибка при удалении' }));
                showMessage(data.error || 'Ошибка при удалении', 'error');
                return;
            }

            showMessage('Запись удалена', 'success');
            loadItems();
            loadAnalytics();
        } catch (error) {
            showMessage('Ошибка: ' + error.message, 'error');
        }
    }

    function resetForm() {
        document.getElementById('itemForm').reset();
        document.getElementById('date').value = new Date().toISOString().slice(0, 16);
    }

    async function exportCSV() {
        const params = new URLSearchParams();
        if (document.getElementById('filterFrom').value) {
            params.append('from', document.getElementById('filterFrom').value + 'T00:00:00Z');
        }
        if (document.getElementById('filterTo').value) {
            params.append('to', document.getElementById('filterTo').value + 'T23:59:59Z');
        }
        if (document.getElementById('filterType').value) {
            params.append('type', document.getElementById('filterType').value);
        }
        if (document.getElementById('filterCategory').value) {
            params.append('category', document.getElementById('filterCategory').value);
        }

        try {
            const response = await fetch(`/api/export?${params}`);
            if (!response.ok) {
                const error = await response.json().catch(() => ({ error: 'Ошибка при экспорте' }));
                showMessage(error.error || 'Ошибка при экспорте CSV', 'error');
                return;
            }
            
            // Если ответ успешный, скачиваем файл
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'items.csv';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        } catch (error) {
            showMessage('Ошибка: ' + error.message, 'error');
        }
    }

    function showMessage(message, type) {
        const messageDiv = document.getElementById('message');
        messageDiv.className = type;
        messageDiv.textContent = message;
        messageDiv.style.display = 'block';
        
        setTimeout(() => {
            messageDiv.style.display = 'none';
        }, 5000);
    }
</script>
</body>
</html>
